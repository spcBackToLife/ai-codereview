name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  code-review:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 需要完整历史记录来对比分支
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      # 安装 ai-codereview npm 包
      - name: Install ai-codereview
        run: npm install -g @aicodereview/ai-code-review
      
      - name: Run AI Code Review
        env:
          LLM_PROVIDER: ${{ secrets.LLM_PROVIDER || 'openai' }}
          LLM_MODEL_NAME: ${{ secrets.LLM_MODEL_NAME || 'gpt-3.5-turbo' }}
          LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
          LLM_BASE_URL: ${{ secrets.LLM_BASE_URL }}
          LLM_MAX_TOKENS: ${{ secrets.LLM_MAX_TOKENS || '8192' }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
          GITHUB_REPOSITORY_NAME: ${{ github.event.repository.name }}
          GITHUB_PR_NUMBER: ${{ github.event.pull_request.number }}
          GITHUB_BASE_REF: ${{ github.event.pull_request.base.ref }}
        run: |
          code-review-github \
            --pwd ${{ github.workspace }} \
            --max-retries ${{ secrets.MAX_RETRIES || '10' }} \
            --review-event COMMENT \
            --output .code-review
        continue-on-error: true  # 即使审查失败也不阻止 PR
      
      - name: Upload review results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-review-results
          path: .code-review/
          retention-days: 7
          
      # 可选: 如果不想全局安装，可以使用 npx（需要先安装包，然后执行命令）
      # - name: Install ai-codereview (local)
      #   run: npm install @aicodereview/ai-code-review
      # 
      # - name: Run AI Code Review (with npx)
      #   env:
      #     LLM_PROVIDER: ${{ secrets.LLM_PROVIDER || 'openai' }}
      #     LLM_MODEL_NAME: ${{ secrets.LLM_MODEL_NAME || 'gpt-3.5-turbo' }}
      #     LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
      #     LLM_BASE_URL: ${{ secrets.LLM_BASE_URL }}
      #     LLM_MAX_TOKENS: ${{ secrets.LLM_MAX_TOKENS || '8192' }}
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #     GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
      #     GITHUB_REPOSITORY_NAME: ${{ github.event.repository.name }}
      #     GITHUB_PR_NUMBER: ${{ github.event.pull_request.number }}
      #     GITHUB_BASE_REF: ${{ github.event.pull_request.base.ref }}
      #   run: |
      #     npx code-review-github \
      #       --pwd ${{ github.workspace }} \
      #       --max-retries ${{ secrets.MAX_RETRIES || '10' }} \
      #       --review-event COMMENT \
      #       --output .code-review
      #   continue-on-error: true

